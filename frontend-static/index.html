<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng điều khiển tạo nội dung Kobi</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f0f2f5; }
        .main-container { max-width: 800px; margin: 2em auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em;}
        .step-card { background-color: white; border-radius: 8px; padding: 1.5em; margin-bottom: 1.5em; box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); }
        h1 { text-align: center; color: #333; }
        h2 { color: #1877f2; border-bottom: 2px solid #eee; padding-bottom: 0.5em; }
        label { display: block; margin-bottom: 0.5em; font-weight: 600; color: #606770; }
        input[type="text"], input[type="number"] { width: 100%; padding: 0.8em; margin-bottom: 1em; box-sizing: border-box; border: 1px solid #dddfe2; border-radius: 6px; }
        button { padding: 0.8em 1.5em; background-color: #1877f2; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: bold; }
        button:hover { background-color: #166fe5; }
        .response-message { margin-top: 1em; padding: 1em; border-radius: 6px; word-break: break-all; }
        .response-message.success { background-color: #e6ffed; border: 1px solid #b7ebc9; color: #257942; }
        .response-message.error { background-color: #ffebe6; border: 1px solid #ffc9ba; color: #c5300b; }
        .guidance { font-size: 0.9em; color: #606770; margin-bottom: 1em; }
        .back-link { text-decoration: none; font-weight: 600; color: #1877f2; font-size: 0.9em; }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="header">
            <h1>Bảng điều khiển tạo nội dung</h1>
            <a href="dashboard.html" class="back-link">&larr; Quay về Dashboard</a>
        </div>

        <!-- Step 1: Create Course -->
        <div class="step-card">
            <h2>Bước 1: Tạo Khóa học</h2>
            <form id="create-course-form">
                <label for="course-title">Tên khóa học:</label>
                <input type="text" id="course-title" required>
                <label for="course-description">Mô tả:</label>
                <input type="text" id="course-description" required>
                <button type="submit">Tạo Khóa học</button>
            </form>
            <div id="course-response" class="response-message"></div>
        </div>

        <!-- Step 2: Create Section -->
        <div class="step-card">
            <h2>Bước 2: Thêm Phần vào Khóa học</h2>
            <p class="guidance">ID của khóa học sẽ được tự động điền vào sau khi tạo thành công ở Bước 1.</p>
            <form id="create-section-form">
                <label for="course-id">ID Khóa học:</label>
                <input type="text" id="course-id" required>
                <label for="section-title">Tên Phần:</label>
                <input type="text" id="section-title" required>
                <button type="submit">Tạo Phần</button>
            </form>
            <div id="section-response" class="response-message"></div>
        </div>

        <!-- Step 3: Create Lesson -->
        <div class="step-card">
            <h2>Bước 3: Thêm Bài học vào Phần</h2>
            <p class="guidance">ID của phần sẽ được tự động điền vào sau khi tạo thành công ở Bước 2.</p>
            <form id="create-lesson-form">
                <label for="section-id">ID Phần:</label>
                <input type="text" id="section-id" required>
                <label for="lesson-title">Tên Bài học:</label>
                <input type="text" id="lesson-title" required>
                <button type="submit">Tạo Bài học</button>
            </form>
            <div id="lesson-response" class="response-message"></div>
        </div>
    </div>

    <script>
        const API_GATEWAY_URL = 'http://localhost:8888/api/course';

        // *** BẢO VỆ: Lấy và kiểm tra accessToken ***
        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
            window.location.href = 'auth.html';
        }

        async function handleApiCall(endpoint, data, responseElementId) {
            const responseDiv = document.getElementById(responseElementId);
            responseDiv.innerHTML = '';
            responseDiv.className = 'response-message';

            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        // *** GỬI TOKEN: Thêm accessToken vào header của mỗi yêu cầu ***
                        'Authorization': `Bearer ${accessToken}` 
                    },
                    body: JSON.stringify(data)
                });

                if (response.status === 401 || response.status === 403) {
                    localStorage.removeItem('accessToken');
                    localStorage.removeItem('refreshToken');
                    window.location.href = 'auth.html';
                    return null;
                }

                const result = await response.json();

                if (response.ok) {
                    let successMessage = `Thành công!`;
                    if (result.data && result.data.id) {
                        successMessage = `Tạo thành công! ID là: <strong>${result.data.id}</strong>.`;
                    }
                    responseDiv.innerHTML = successMessage;
                    responseDiv.classList.add('success');
                    return result.data;
                } else {
                    responseDiv.textContent = 'Lỗi: ' + (result.message || 'Thao tác thất bại.');
                    responseDiv.classList.add('error');
                }
            } catch (error) {
                console.error('Fetch Error:', error);
                responseDiv.textContent = 'Lỗi kết nối tới server. Hãy kiểm tra Console (F12).';
                responseDiv.classList.add('error');
            }
            return null;
        }

        document.getElementById('create-course-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                title: document.getElementById('course-title').value,
                description: document.getElementById('course-description').value
            };
            const createdData = await handleApiCall(`${API_GATEWAY_URL}/v1/created`, data, 'course-response');
            if (createdData && createdData.id) {
                document.getElementById('course-id').value = createdData.id;
            }
        });

        document.getElementById('create-section-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const courseId = document.getElementById('course-id').value;
            const data = {
                title: document.getElementById('section-title').value
            };
            const createdData = await handleApiCall(`${API_GATEWAY_URL}/section/created/${courseId}`, data, 'section-response');
            if (createdData && createdData.id) {
                document.getElementById('section-id').value = createdData.id;
            }
        });

        document.getElementById('create-lesson-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const sectionId = document.getElementById('section-id').value;
            const data = {
                title: document.getElementById('lesson-title').value
            };
            await handleApiCall(`${API_GATEWAY_URL}/lesson/created/${sectionId}`, data, 'lesson-response');
        });
    </script>

</body>
</html>
